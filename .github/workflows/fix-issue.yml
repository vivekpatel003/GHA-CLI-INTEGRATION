name: CI (with Copilot fix attempt)
 
on:

  pull_request:

  workflow_dispatch:

  push:

    branches: [ master ]
 
permissions:

  contents: write

  pull-requests: write
 
jobs:

  test:

    runs-on: ubuntu-latest
 
    steps:

      - uses: actions/checkout@v5
 
      - name: Setup Node

        uses: actions/setup-node@v4

        with:

          node-version: 24

          cache: npm
 
      - name: Install

        run: npm ci
 
      - name: Debug token presence

        shell: bash

        run: |

          if [ -z "${{ secrets.COPILOT_TOKEN }}" ]; then

            echo "COPILOT_TOKEN secret is EMPTY or not available in this run."

            exit 1

          else

            echo "COPILOT_TOKEN secret is present (not empty)."

          fi
 
 
      - name: Run tests (capture log)

        id: tests

        continue-on-error: true

        shell: bash

        run: |

          npm test 2>&1 | tee test.log

          exit ${PIPESTATUS[0]}
 
      # Only try Copilot when:

      # - tests failed

      # - and either it's not a PR event, or it's a same-repo PR (not a fork)

      - name: Debug token types
        run: |
          echo "Checking token types..."
          echo "GITHUB_TOKEN length: ${#GITHUB_TOKEN}"
          echo "COPILOT_TOKEN length: ${#COPILOT_TOKEN}"
          
          # Try to identify token type
          if curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user | grep -q "login"; then
            echo "GITHUB_TOKEN is a valid GitHub token"
          else
            echo "GITHUB_TOKEN may be an Actions token without user scope"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}

      - name: If tests failed, ask Copilot to fix and open PR
        if: steps.tests.outcome == 'failure' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: austenstone/copilot-cli@v2.0
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        with:
          skip-gh-auth: true
          prompt: |
            You are fixing failing CI tests in this repo.

            Steps:
            1) Read ./test.log to identify the failing test(s) and root cause.
            2) Use playwright-test-healer.agent.md agent present in the repository to fix the issues.
            3) Run `npm test` to confirm green.
            4) Create a new branch, commit, and open a *draft PR* describing the fix.

            Notes:
            - The test output is in ./test.log.


 