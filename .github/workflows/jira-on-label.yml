name: Create Jira when Copilot requests (needs-jira)

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  create_jira:
    if: github.event.label.name == 'needs-jira'
    runs-on: ubuntu-latest
    steps:
      - name: Jira login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Create Jira issue
        id: jira
        uses: atlassian/gajira-create@v3
        with:
          project: ${{ secrets.JIRA_PROJECT_KEY }}
          issuetype: Bug
          summary: "Playwright CI site/product issue – ${{ github.repository }} – GH Issue #${{ github.event.issue.number }}"
          description: |
            Copilot flagged this as requiring Jira.

            GitHub Issue: ${{ github.event.issue.html_url }}
            Title: ${{ github.event.issue.title }}

            ---- GitHub Issue Body ----
            ${{ github.event.issue.body }}

      - name: Comment back with Jira key
        uses: actions/github-script@v7
        with:
          script: |
            const jiraKey = `${{ steps.jira.outputs.issue }}` || 'UNKNOWN';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `✅ Created Jira ticket: **${jiraKey}**`
            });
